<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grocery Price Tracker App</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Light gray background */
            color: #1e293b; /* Dark text */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top for better scrolling */
            min-height: 100vh;
            padding: 2rem;
            box-sizing: border;
        }
        .container {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1.5rem; /* More rounded corners */
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 768px; /* Max width for readability */
            width: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        h1 {
            color: #1a202c; /* Darker heading */
            font-size: 2.8rem; /* Larger heading */
            font-weight: 700;
            text-align: center;
            margin-bottom: 1.5rem;
        }
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            position: relative; /* Needed for absolute positioning of autocomplete suggestions */
        }
        .input-group label {
            font-weight: 600;
            color: #475569;
        }
        .input-group input[type="text"],
        .input-group input[type="number"],
        .input-group select { /* Added select to styling */
            padding: 0.8rem 1rem;
            border: 1px solid #cbd5e1; /* Light border */
            border-radius: 0.75rem; /* Rounded input fields */
            font-size: 1rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            width: 100%;
            box-sizing: border-box;
        }
        .input-group input[type="text"]:focus,
        .input-group input[type="number"]:focus,
        .input-group select:focus { /* Added select to focus styling */
            outline: none;
            border-color: #3B82F6; /* Blue focus border */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); /* Blue shadow on focus */
        }
        .btn-primary {
            background-color: #3B82F6; /* Blue button */
            color: white;
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 0.75rem;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.2);
            width: 100%;
        }
        .btn-primary:hover {
            background-color: #2563eb; /* Darker blue on hover */
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
        }
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.2);
        }
        /* Removed install-button styling as it's no longer used */
        .product-list {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .product-item {
            background-color: #f1f5f9; /* Lighter background for items */
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            cursor: pointer; /* Indicate it's clickable */
            transition: transform 0.1s ease, box-shadow 0.1s ease;
        }
        .product-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
        }
        .product-item:active {
            transform: translateY(0);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        .product-item h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1e293b;
        }
        .product-item p {
            font-size: 0.95rem;
            color: #475569;
        }
        .price-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.5rem 1rem;
            margin-top: 0.5rem;
            align-items: center;
        }
        .price-info-grid > div {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        /* Changed generic span styling as specific classes are now used */
        .price-info-grid .label {
            font-size: 0.8rem;
            color: #64748b;
            font-weight: 500;
        }
        .price-info-grid .value {
            font-size: 1rem;
            font-weight: 600;
            color: #1e293b; /* Default value color if not specifically overridden */
        }
        .price-info-grid .current-price-value {
            color: #3B82F6; /* Blue for Current Price */
            font-size: 1.2rem;
        }
        .price-info-grid .avg-price-value {
            color: #F59E0B; /* Amber (Yellow) for Average Price - Tailwind amber-500/600 */
        }
        .price-info-grid .high-price-value {
            color: #dc2626; /* Red for Highest Price */
        }
        .price-info-grid .low-price-value {
            color: #10B981; /* Green for Lowest Price - Tailwind emerald-500/600 */
        }

        .btn-secondary {
            background-color: #e2e8f0;
            color: #1e293b;
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 0.6rem;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }
        .btn-secondary:hover {
            background-color: #cbd5e1;
            transform: translateY(-1px);
        }
        .btn-secondary:active {
            transform: translateY(0);
        }
        .delete-btn {
            background-color: #ef4444;
            color: white;
        }
        .delete-btn:hover {
            background-color: #dc2626;
        }

        /* Modal specific styles (General) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Ensure it's on top */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25);
            max-width: 500px;
            width: 90%;
            position: relative;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }
        .modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #64748b;
            transition: color 0.2s ease;
        }
        .modal-close-btn:hover {
            color: #1e293b;
        }

        /* Settings Button */
        .settings-button-container {
            /* Removed width: 100% and text-align: right */
            /* Flex parent will handle alignment */
            /* margin-bottom: 1rem; removed as well, let parent handle gap */
        }
        .settings-button {
            background-color: #60a5fa; /* A lighter blue */
            color: white;
            /* Smaller padding and font size for the icon button */
            padding: 0.6rem 0.8rem; /* Adjusted padding */
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 3px 10px rgba(96, 165, 250, 0.2);
            display: flex; /* Use flex to center the icon if needed */
            align-items: center;
            justify-content: center;
            font-size: 1.2rem; /* Size of the icon */
        }
        .settings-button:hover {
            background-color: #3b82f6;
            transform: translateY(-2px);
        }
        .settings-button:active {
            transform: translateY(0);
        }

        /* Confirmation & Update Price Modal specific styles */
        .confirm-modal-content, .update-price-modal-content {
            text-align: center;
        }
        .confirm-modal-content h3, .update-price-modal-content h3 {
            font-size: 1.8rem;
            color: #1e293b;
            margin-bottom: 1rem;
        }
        .confirm-modal-content p, .update-price-modal-content p {
            font-size: 1.1rem;
            color: #475569;
            margin-bottom: 2rem;
        }
        .confirm-buttons, .update-price-buttons {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
        }
        .confirm-buttons .btn, .update-price-buttons .btn { /* General button styling for confirm buttons */
            padding: 0.8rem 1.8rem;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .confirm-buttons .btn-yes, .update-price-buttons .btn-confirm {
            background-color: #ef4444; /* Red for Yes/Confirm */
            color: white;
        }
        .confirm-buttons .btn-yes:hover, .update-price-buttons .btn-confirm:hover {
            background-color: #dc2626;
            transform: translateY(-2px);
        }
        .confirm-buttons .btn-no, .update-price-buttons .btn-cancel {
            background-color: #cbd5e1; /* Gray for No/Cancel */
            color: #1e293b;
        }
        .confirm-buttons .btn-no:hover, .update-price-buttons .btn-cancel:hover {
            background-color: #aebacd;
            transform: translateY(-2px);
        }
        .update-price-modal-content input[type="number"],
        .update-price-modal-content input[type="text"] { /* Added text type for store input */
            margin-top: 1rem;
            padding: 0.8rem 1rem;
            border: 1px solid #cbd5e1;
            border-radius: 0.75rem;
            font-size: 1.2rem;
            text-align: center;
            width: calc(100% - 2rem); /* Account for padding */
            max-width: 200px;
            box-sizing: border-box;
        }
        /* Style for store name in product heading */
        .product-item h3 .product-store {
            font-size: 1rem; /* Slightly smaller than product name */
            font-weight: 500;
            color: #64748b; /* Lighter color */
            margin-left: 0.5rem; /* Space between product name and store */
        }
        /* Unified style for any store display inside price info to ensure consistency */
        .price-info-grid .value .store-display { /* Increased specificity here */
            font-size: 0.75rem; /* Smaller font for store name */
            color: #64748b; /* Lighter color */
            font-weight: normal; /* Normal weight */
            margin-left: 0.25rem; /* A bit more separation from price value */
        }

        /* Custom Autocomplete Suggestions Styling */
        .autocomplete-suggestions {
            position: absolute;
            top: 100%; /* Position below the input */
            left: 0;
            right: 0;
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            border-top: none;
            border-radius: 0 0 0.75rem 0.75rem; /* Rounded bottom corners */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            z-index: 999; /* Ensure it's above other content but below modals */
            max-height: 200px; /* Limit height and enable scrolling */
            overflow-y: auto;
            display: none; /* Hidden by default */
        }

        .autocomplete-suggestions div {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9; /* Light separator */
            transition: background-color 0.2s ease;
        }

        .autocomplete-suggestions div:last-child {
            border-bottom: none;
        }

        .autocomplete-suggestions div:hover {
            background-color: #f0f4f8; /* Light hover background */
        }

        /* Generic Error Message Box */
        .error-message-box {
            position: fixed;
            bottom: 1rem;
            left: 1rem;
            background-color: #ef4444; /* Red background */
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none; /* Hidden by default */
            font-size: 0.9rem;
            animation: fadeInOut 5s forwards; /* Fade in and out */
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(20px); }
        }


        /* Responsive adjustments for modal buttons */
        @media (max-width: 480px) {
            .confirm-buttons, .update-price-buttons, .initial-store-buttons { /* Added initial-store-buttons */
                flex-direction: column;
                gap: 1rem;
            }
            .confirm-buttons .btn, .update-price-buttons .btn, .initial-store-buttons .btn { /* Added initial-store-buttons */
                width: 100%;
            }
        }
        /* New responsive adjustments for input grid */
        .input-grid {
            display: flex; /* Default to flex for mobile */
            flex-direction: column; /* Stack items vertically */
            gap: 2.5rem; /* A generous default vertical gap between elements (40px) */
            margin-top: 1rem; /* Margin from the section title */
        }
        @media (min-width: 640px) {
            .input-grid {
                display: grid; /* Switch to grid on larger screens */
                grid-template-columns: 1fr 1fr 1fr; /* 3 equal columns */
                gap-x: 10rem; /* Horizontal gap */
                gap-y: 6rem; /* Large vertical gap between grid rows */
            }
            .btn-primary {
                grid-column: span 3; /* Button spans all 3 columns on desktop */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Error Message Box -->
        <div id="errorMessage" class="error-message-box"></div>

        <!-- Adjusted the parent flex container for better alignment and spacing -->
        <div class="flex justify-between items-center w-full mb-6">
            <!-- Current Store Input Group (Top-Left) -->
            <div class="input-group flex items-center gap-2 relative">
                <label for="defaultStoreNameInput" class="text-sm font-medium text-gray-600 whitespace-nowrap">Current Store:</label>
                <input type="text" id="defaultStoreNameInput" placeholder="e.g., Main Supermarket"
                       class="w-28 sm:w-36 md:w-40 py-1 px-2 text-sm rounded-md border border-gray-300 focus:ring-blue-500 focus:border-blue-500" autocomplete="off">
                <div id="defaultStoreSuggestions" class="autocomplete-suggestions"></div>
            </div>
            <!-- Settings Button (Top-Right) -->
            <div class="settings-button-container">
                <button id="openSettingsBtn" class="settings-button" aria-label="Settings">
                    <i class="fas fa-cog"></i> <!-- Font Awesome Gear Icon -->
                </button>
            </div>
        </div>

        <h1>üõçÔ∏è Grocery Price Tracker</h1>

        <div class="add-product-section bg-gray-50 p-6 rounded-xl shadow-inner">
            <h2 class="text-2xl font-semibold text-center mb-4 text-gray-700">Add New Product</h2>
            <div class="input-grid">
                <div class="input-group">
                    <label for="productName">Product Name:</label>
                    <!-- Input for product name, will use custom autocomplete -->
                    <input type="text" id="productName" placeholder="e.g., Milk" class="focus:ring-blue-500 focus:border-blue-500" autocomplete="off">
                    <div id="productSuggestions" class="autocomplete-suggestions"></div>
                </div>
                <div class="input-group">
                    <label for="initialPrice">Current Price:</label>
                    <input type="number" id="initialPrice" step="0.01" min="0" placeholder="e.g., 3.99" class="focus:ring-blue-500 focus:border-blue-500" autocomplete="off">
                </div>
                <div class="input-group">
                    <label for="productUnit">Unit (Optional):</label>
                    <select id="productUnit" class="focus:ring-blue-500 focus:border-blue-500">
                        <option value="">-- Select Unit --</option>
                        <option value="ea">Each</option>
                        <option value="lb">lb</option>
                        <option value="oz">oz</option>
                        <option value="g">g</option>
                        <option value="kg">kg</option>
                        <option value="fl oz">fl oz</option>
                        <option value="ml">ml</option>
                        <option value="liter">Liter</option>
                        <option value="gallon">Gallon</option>
                        <option value="half_gallon">Half Gallon</option>
                        <option value="pack">Pack</option>
                        <option value="dozen">Dozen</option>
                        <option value="box">Box</option>
                        <option value="bag">Bag</option>
                        <option value="bottle">Bottle</option>
                        <option value="can">Can</option>
                    </select>
                </div>
                <button id="addProductBtn" class="btn-primary">Add Product</button>
            </div>
        </div>

        <div class="tracked-products-section">
            <h2 class="text-2xl font-semibold text-center mb-4 text-gray-700">Tracked Products</h2>
            <div id="productList" class="product-list">
                <!-- Product items will be dynamically added here -->
                <p id="noProductsMessage" class="text-center text-gray-500 italic">No products tracked yet. Add one above!</p>
            </div>
        </div>

        <!-- Removed install button as PWA features are disabled in this environment -->
    </div>

    <!-- Initial Store Selection Modal -->
    <div id="initialStoreModal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-2xl font-semibold text-center mb-4 text-gray-700">Set Current Store</h2>
            <p class="text-gray-600 mb-4 text-center">Please enter the name of your primary grocery store to get started, or skip for now.</p>
            <div class="input-group">
                <label for="initialStoreNameInput">Store Name:</label>
                <input type="text" id="initialStoreNameInput" placeholder="e.g., Main Supermarket"
                       class="focus:ring-blue-500 focus:border-blue-500" autocomplete="off">
                <div id="initialStoreSuggestions" class="autocomplete-suggestions"></div>
            </div>
            <div class="initial-store-buttons mt-6 flex justify-center gap-4">
                <button id="submitInitialStoreBtn" class="btn-primary flex-1">Continue</button>
                <button id="skipInitialStoreBtn" class="btn-secondary flex-1">Skip</button>
            </div>
        </div>
    </div>


    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" id="closeSettingsBtn">&times;</button>
            <h2 class="text-2xl font-semibold text-center mb-4 text-gray-700">Settings</h2>
            <div class="input-group">
                <label for="modernPriceWindowMonths">Modern Price Window (Months):</label>
                <input type="number" id="modernPriceWindowMonths" value="12" min="1" class="focus:ring-blue-500 focus:border-blue-500">
                <p class="text-sm text-gray-500 mt-1">High and Low prices will only consider prices from the last X months.</p>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal-overlay">
        <div class="modal-content confirm-modal-content">
            <h3>Confirm Deletion</h3>
            <p id="confirmMessage">Are you sure you want to delete this product?</p>
            <div class="confirm-buttons">
                <button id="confirmDeleteBtn" class="btn btn-yes">Yes, Delete</button>
                <button id="cancelDeleteBtn" class="btn btn-no">No, Cancel</button>
            </div>
        </div>
    </div>

    <!-- Update Price Modal -->
    <div id="updatePriceModal" class="modal-overlay">
        <div class="modal-content update-price-modal-content">
            <button class="modal-close-btn" id="closeUpdatePriceModalBtn">&times;</button>
            <h3 id="updatePriceModalTitle">Update Price for Product</h3>
            <p id="updatePriceModalCurrentPrice"></p>
            <div class="input-group">
                <label for="newPriceInput">New Price:</label>
                <input type="number" id="newPriceInput" step="0.01" min="0" placeholder="e.g., 4.25" class="focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="input-group">
                <label for="updatePriceModalStoreInput">Store Name (Optional):</label>
                <!-- Input for update modal store, will use custom autocomplete -->
                <input type="text" id="updatePriceModalStoreInput" placeholder="e.g., Target" class="focus:ring-blue-500 focus:border-blue-500" autocomplete="off">
                <div id="updateStoreSuggestions" class="autocomplete-suggestions"></div>
            </div>
            <div class="update-price-buttons mt-6">
                <button id="submitNewPriceBtn" class="btn btn-confirm">Update</button>
                <button id="cancelNewPriceBtn" class="btn btn-cancel">Cancel</button>
            </div>
        </div>
    </div>


    <script>
        // DOM Elements
        const productNameInput = document.getElementById('productName');
        const productUnitInput = document.getElementById('productUnit');
        const initialPriceInput = document.getElementById('initialPrice');
        const addProductBtn = document.getElementById('addProductBtn');
        const productListDiv = document.getElementById('productList');
        const noProductsMessage = document.getElementById('noProductsMessage');
        // const installButton = document.getElementById('installButton'); // Removed as PWA is disabled
        const modernPriceWindowMonthsInput = document.getElementById('modernPriceWindowMonths');
        const errorMessageDiv = document.getElementById('errorMessage'); // New error message div

        // New Default Store Input & its custom suggestions
        const defaultStoreNameInput = document.getElementById('defaultStoreNameInput');
        const defaultStoreSuggestions = document.getElementById('defaultStoreSuggestions');

        // Custom suggestions for products
        const productSuggestions = document.getElementById('productSuggestions');

        // Modal Elements
        const openSettingsBtn = document.getElementById('openSettingsBtn');
        const closeSettingsBtn = document.getElementById('closeSettingsBtn');
        const settingsModal = document.getElementById('settingsModal');

        // Initial Store Modal Elements
        const initialStoreModal = document.getElementById('initialStoreModal');
        const initialStoreNameInput = document.getElementById('initialStoreNameInput');
        const initialStoreSuggestions = document.getElementById('initialStoreSuggestions');
        const submitInitialStoreBtn = document.getElementById('submitInitialStoreBtn');
        const skipInitialStoreBtn = document.getElementById('skipInitialStoreBtn'); // New Skip button


        // Confirmation Modal Elements
        const confirmModal = document.getElementById('confirmModal');
        const confirmMessage = document.getElementById('confirmMessage');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');

        // Update Price Modal Elements
        const updatePriceModal = document.getElementById('updatePriceModal');
        const closeUpdatePriceModalBtn = document.getElementById('closeUpdatePriceModalBtn');
        const updatePriceModalTitle = document.getElementById('updatePriceModalTitle');
        const updatePriceModalCurrentPrice = document.getElementById('updatePriceModalCurrentPrice');
        const newPriceInput = document.getElementById('newPriceInput');
        const updatePriceModalStoreInput = document.getElementById('updatePriceModalStoreInput');
        const updateStoreSuggestions = document.getElementById('updateStoreSuggestions'); // Custom suggestions for update modal
        const submitNewPriceBtn = document.getElementById('submitNewPriceBtn');
        const cancelNewPriceBtn = document.getElementById('cancelNewPriceBtn');

        let deferredPrompt; // For PWA install prompt (kept as placeholder for consistency if PWA is re-enabled later)
        let productToDeleteId = null; // Store ID of product to be deleted
        let productToUpdateIndex = null; // Store index of product being updated
        let defaultStoreName = ''; // Global variable for the selected default store

        // Define inactivity timeout (1 hour in milliseconds)
        const INACTIVITY_TIMEOUT_MS = 60 * 60 * 1000; // 1 hour

        // Function to display error messages
        function showErrorMessage(message) {
            errorMessageDiv.textContent = message;
            errorMessageDiv.style.display = 'block';
            setTimeout(() => {
                errorMessageDiv.style.display = 'none';
            }, 5000); // Hide after 5 seconds
        }

        // --- PWA Service Worker Registration (DISABLED FOR THIS ENVIRONMENT) ---
        // if ('serviceWorker' in navigator) {
        //     window.addEventListener('load', () => {
        //         navigator.serviceWorker.register('/service-worker.js')
        //             .then(registration => {
        //                 console.log('Service Worker registered:', registration);
        //             })
        //             .catch(error => {
        //                 console.error('Service Worker registration failed:', error);
        //                 showErrorMessage('App might not work offline: Service Worker registration failed.');
        //             });
        //     });
        // }

        // --- PWA Install Prompt Logic (DISABLED FOR THIS ENVIRONMENT) ---
        // window.addEventListener('beforeinstallprompt', (e) => {
        //     e.preventDefault();
        //     deferredPrompt = e;
        //     installButton.classList.remove('hidden');
        // });

        // installButton.addEventListener('click', () => {
        //     installButton.classList.add('hidden');
        //     if (deferredPrompt) {
        //         deferredPrompt.prompt();
        //         deferredPrompt.userChoice.then((choiceResult) => {
        //             if (choiceResult.outcome === 'accepted') {
        //                 console.log('User accepted the A2HS prompt');
        //             } else {
        //                 console.log('User dismissed the A2HS prompt');
        //             }
        //             deferredPrompt = null;
        //         });
        //     }
        // });

        // window.addEventListener('appinstalled', () => {
        //     console.log('PWA was installed!');
        //     installButton.classList.add('hidden');
        // });

        // --- Product Tracking Logic ---

        let products = JSON.parse(localStorage.getItem('trackedProducts')) || [];
        let modernPriceWindowMonths = parseInt(localStorage.getItem('modernPriceWindowMonths')) || 12;
        modernPriceWindowMonthsInput.value = modernPriceWindowMonths;

        // Load default store name from localStorage on startup
        defaultStoreName = localStorage.getItem('defaultStoreName') || '';
        defaultStoreNameInput.value = defaultStoreName; // Also update the visible input field


        // Function to update the last active timestamp
        function updateLastActiveTimestamp() {
            localStorage.setItem('lastActiveTimestamp', Date.now());
            console.log('Last active timestamp updated.');
        }

        // Event listener for the default store input
        defaultStoreNameInput.addEventListener('input', (event) => {
            defaultStoreName = event.target.value.trim();
            localStorage.setItem('defaultStoreName', defaultStoreName); // Save to localStorage
            updateLastActiveTimestamp(); // Update timestamp on store name change
        });

        // Helper functions to get unique names for autocomplete
        function getUniqueProductNames() {
            const uniqueNames = new Set();
            products.forEach(product => {
                uniqueNames.add(product.name);
            });
            return Array.from(uniqueNames).sort();
        }

        function getUniqueStoreNames() {
            const uniqueNames = new Set();
            products.forEach(product => {
                product.priceHistory.forEach(entry => {
                    if (entry.store) {
                        uniqueNames.add(entry.store);
                    }
                });
            });
            return Array.from(uniqueNames).sort();
        }

        // Function to set up custom autocomplete for an input field
        function setupAutocomplete(inputElement, suggestionsContainer, getSuggestionsFunction) {
            let timeout = null; // To handle blur event delay

            inputElement.addEventListener('input', () => {
                const inputValue = inputElement.value.trim().toLowerCase();
                suggestionsContainer.innerHTML = ''; // Clear previous suggestions

                if (inputValue.length === 0) {
                    suggestionsContainer.style.display = 'none';
                    // If the input is cleared, also clear the unit if it's the product name input
                    if (inputElement.id === 'productName') {
                        productUnitInput.value = '';
                    }
                    return;
                }

                const allSuggestions = getSuggestionsFunction();
                const filteredSuggestions = allSuggestions
                    .filter(name => name.toLowerCase().startsWith(inputValue));

                if (filteredSuggestions.length > 0) {
                    filteredSuggestions.forEach(name => {
                        const suggestionDiv = document.createElement('div');
                        suggestionDiv.textContent = name;
                        suggestionDiv.addEventListener('mousedown', (event) => { // Use mousedown to prevent blur from hiding it
                            event.preventDefault(); // Prevent input from losing focus immediately
                            inputElement.value = name;
                            suggestionsContainer.style.display = 'none';

                            // If this is the default store input OR initial store input, update the global defaultStoreName
                            if (inputElement.id === 'defaultStoreNameInput' || inputElement.id === 'initialStoreNameInput') {
                                defaultStoreName = name;
                                localStorage.setItem('defaultStoreName', defaultStoreName);
                            }
                            // If this is the product name input, and a product exists with this name,
                            // populate the unit and price fields based on that product's latest entry
                            if (inputElement.id === 'productName') {
                                const product = products.find(p => p.name.toLowerCase() === name.toLowerCase());
                                if (product) {
                                    // Set the unit value from the product's unit property
                                    productUnitInput.value = product.unit || '';
                                    console.log(`Setting productUnitInput.value to: ${productUnitInput.value} (from product.unit: ${product.unit})`); // Debugging line

                                    if (product.priceHistory && product.priceHistory.length > 0) {
                                        initialPriceInput.value = product.priceHistory[product.priceHistory.length - 1].price || '';
                                    } else {
                                        initialPriceInput.value = '';
                                    }
                                }
                            }
                            updateLastActiveTimestamp(); // Update timestamp on selection
                        });
                        suggestionsContainer.appendChild(suggestionDiv);
                    });
                    suggestionsContainer.style.display = 'block';
                } else {
                    suggestionsContainer.style.display = 'none';
                    // If no suggestions, and it's the product name input, clear the unit
                    if (inputElement.id === 'productName') {
                        productUnitInput.value = '';
                    }
                }
            });

            inputElement.addEventListener('blur', () => {
                // Delay hiding to allow click event on suggestions to fire
                timeout = setTimeout(() => {
                    suggestionsContainer.style.display = 'none';
                }, 100);
            });

            inputElement.addEventListener('focus', () => {
                 // Clear suggestions on focus. They will reappear on typing.
                 suggestionsContainer.innerHTML = '';
                 suggestionsContainer.style.display = 'none';
                 if (timeout) clearTimeout(timeout);
            });
        }


        function updateProductStatistics(product) {
            if (product.priceHistory && product.priceHistory.length > 0) {
                const now = new Date();
                const currentMonthTotal = now.getFullYear() * 12 + now.getMonth();

                const modernPrices = product.priceHistory.filter(entry => {
                    const priceDate = new Date(entry.timestamp);
                    const entryMonthTotal = priceDate.getFullYear() * 12 + priceDate.getMonth();
                    const diffMonths = currentMonthTotal - entryMonthTotal;
                    return diffMonths <= modernPriceWindowMonths;
                }).map(entry => entry.price);

                const allPrices = product.priceHistory.map(entry => entry.price);

                product.currentPrice = allPrices[allPrices.length - 1]; // Latest price is always current

                product.averagePrice = allPrices.reduce((sum, p) => sum + p, 0) / allPrices.length;

                if (modernPrices.length > 0) {
                    const highestPriceValue = Math.max(...modernPrices);
                    const lowestPriceValue = Math.min(...modernPrices);

                    // Find the entry that corresponds to the highest price within the modern window
                    const highestEntry = product.priceHistory.find(entry =>
                        entry.price === highestPriceValue &&
                        (currentMonthTotal - (new Date(entry.timestamp).getFullYear() * 12 + new Date(entry.timestamp).getMonth())) <= modernPriceWindowMonths
                    );
                    // Find the entry that corresponds to the lowest price within the modern window
                    const lowestEntry = product.priceHistory.find(entry =>
                        entry.price === lowestPriceValue &&
                        (currentMonthTotal - (new Date(entry.timestamp).getFullYear() * 12 + new Date(entry.timestamp).getMonth())) <= modernPriceWindowMonths
                    );

                    product.highestPrice = highestPriceValue;
                    product.highestPriceStore = highestEntry ? highestEntry.store : 'N/A';

                    product.lowestPrice = lowestPriceValue;
                    product.lowestPriceStore = lowestEntry ? lowestEntry.store : 'N/A';

                } else {
                    product.currentPrice = null;
                    product.averagePrice = null;
                    product.highestPrice = null;
                    product.lowestPrice = null;
                    product.highestPriceStore = null;
                    product.lowestPriceStore = null;
                }
            } else {
                product.currentPrice = null;
                product.averagePrice = null;
                product.highestPrice = null;
                product.lowestPrice = null;
                product.highestPriceStore = null;
                product.lowestPriceStore = null;
            }
        }

        function renderProducts() {
            console.log("Rendering products...");
            productListDiv.innerHTML = '';
            if (products.length === 0) {
                noProductsMessage.classList.remove('hidden');
                productListDiv.appendChild(noProductsMessage);
                console.log("No products to display.");
                return;
            } else {
                noProductsMessage.classList.add('hidden');
            }

            const sortedProducts = [...products].sort((a, b) => a.name.localeCompare(b.name));

            sortedProducts.forEach((product) => {
                updateProductStatistics(product);

                const latestPriceEntry = product.priceHistory.length > 0 ? product.priceHistory[product.priceHistory.length - 1] : null;
                const latestStoreForHeader = latestPriceEntry && latestPriceEntry.store ? latestPriceEntry.store : '';

                const productItem = document.createElement('div');
                productItem.className = 'product-item';
                productItem.dataset.productName = product.name;
                productItem.dataset.productId = product.id;
                productItem.innerHTML = `
                    <div class="product-details">
                        <h3>${product.name} ${product.unit ? `<span class="text-gray-500 text-sm font-normal">(${product.unit})</span>` : ''}
                            ${latestStoreForHeader ? `<span class="product-store">(${latestStoreForHeader})</span>` : ''}
                        </h3>
                    </div>
                    <div class="price-actions">
                        <div class="price-info-grid">
                            <div>
                                <span class="label">Current Price:</span>
                                <span class="value current-price-value">$${product.currentPrice ? product.currentPrice.toFixed(2) : 'N/A'}${latestPriceEntry && latestPriceEntry.store ? ` <span class="store-display">(${latestPriceEntry.store})</span>` : ''}</span>
                            </div>
                            <div>
                                <span class="label">Average Price:</span>
                                <span class="value avg-price-value">$${product.averagePrice ? product.averagePrice.toFixed(2) : 'N/A'}</span>
                            </div>
                            <div>
                                <span class="label">Highest Price (Modern):</span>
                                <span class="value high-price-value">$${product.highestPrice ? product.highestPrice.toFixed(2) : 'N/A'}${product.highestPriceStore ? ` <span class="store-display">(${product.highestPriceStore})</span>` : ''}</span>
                            </div>
                            <div>
                                <span class="label">Lowest Price (Modern):</span>
                                <span class="value low-price-value">$${product.lowestPrice ? product.lowestPrice.toFixed(2) : 'N/A'}${product.lowestPriceStore ? ` <span class="store-display">(${product.lowestPriceStore})</span>` : ''}</span>
                            </div>
                        </div>
                        <small class="text-gray-500 mt-2">
                            Last Updated: ${latestPriceEntry ? new Date(latestPriceEntry.timestamp).toLocaleString() : 'Never'}
                            ${latestStoreForHeader ? ` at <strong>${latestStoreForHeader}</strong>` : ''}
                        </small>
                        <div class="flex flex-col sm:flex-row gap-2 mt-2"> <!-- New div for buttons -->
                            <button class="btn-secondary check-price-btn w-full sm:w-auto" data-product-id="${product.id}">Update Price</button>
                            <button class="btn-secondary delete-product-btn delete-btn w-full sm:w-auto" data-product-id="${product.id}">Delete</button>
                        </div>
                    </div>
                `;
                productListDiv.appendChild(productItem);
            });
            console.log("Products rendered successfully.");
            updateLastActiveTimestamp(); // Update timestamp after rendering
            // Event delegation for clicks on product items and buttons
            productListDiv.onclick = (event) => {
                if (event.target.closest('.product-item')) {
                    const item = event.target.closest('.product-item');
                    if (!event.target.closest('.check-price-btn') && !event.target.closest('.delete-product-btn')) {
                        const productName = item.dataset.productName;
                        if (productName) {
                            console.log(`Product item clicked: ${productName}`);
                            productNameInput.value = productName;
                            // Pre-fill the unit and price fields based on the selected product
                            const product = products.find(p => p.name.toLowerCase() === productName.toLowerCase()); // Use toLowerCase for case-insensitive match
                            if (product) {
                                productUnitInput.value = product.unit || '';
                                console.log(`Setting productUnitInput.value to: ${productUnitInput.value} (from product.unit: ${product.unit})`); // Debugging line

                                if (product.priceHistory && product.priceHistory.length > 0) {
                                    initialPriceInput.value = product.priceHistory[product.priceHistory.length - 1].price || '';
                                } else {
                                    initialPriceInput.value = '';
                                }
                                console.log(`Setting initialPriceInput.value to: ${initialPriceInput.value}`); // Debugging line

                                // Do NOT update defaultStoreNameInput here
                                // if (product.priceHistory && product.priceHistory.length > 0 && product.priceHistory[product.priceHistory.length - 1].store) {
                                //     defaultStoreNameInput.value = product.priceHistory[product.priceHistory.length - 1].store;
                                //     defaultStoreName = defaultStoreNameInput.value;
                                //     localStorage.setItem('defaultStoreName', defaultStoreName);
                                // }
                            }
                        }
                    }
                }

                if (event.target.classList.contains('check-price-btn')) {
                    const productId = parseInt(event.target.dataset.productId);
                    const productIndex = products.findIndex(p => p.id === productId);
                    if (productIndex > -1) {
                        showUpdatePriceModal(productIndex);
                    }
                }

                if (event.target.classList.contains('delete-product-btn')) {
                    const productId = parseInt(event.target.dataset.productId);
                    const product = products.find(p => p.id === productId);
                    if (product) {
                        productToDeleteId = productId;
                        confirmMessage.textContent = `Are you sure you want to delete "${product.name}"?`;
                        confirmModal.classList.add('show');
                    }
                }
                updateLastActiveTimestamp(); // Update timestamp on product item click
            };
        }

        function performDeleteProduct() {
            if (productToDeleteId !== null) {
                const indexToDelete = products.findIndex(p => p.id === productToDeleteId);
                if (indexToDelete > -1) {
                    products.splice(indexToDelete, 1);
                    saveProducts();
                    renderProducts();
                    console.log(`Product with ID ${productToDeleteId} deleted.`);
                }
                productToDeleteId = null;
            }
            confirmModal.classList.remove('show');
            updateLastActiveTimestamp(); // Update timestamp after deletion
        }

        confirmDeleteBtn.addEventListener('click', performDeleteProduct);
        cancelDeleteBtn.addEventListener('click', () => {
            confirmModal.classList.remove('show');
            productToDeleteId = null;
            updateLastActiveTimestamp(); // Update timestamp on cancel
        });

        confirmModal.addEventListener('click', (event) => {
            if (event.target === confirmModal) {
                confirmModal.classList.remove('show');
                productToDeleteId = null;
                updateLastActiveTimestamp(); // Update timestamp on modal outside click
            }
        });


        // --- Update Price Modal Logic ---
        function showUpdatePriceModal(productIndex) {
            productToUpdateIndex = productIndex;
            const product = products[productIndex];

            updatePriceModalTitle.textContent = `Update Price for "${product.name}"`;
            updatePriceModalCurrentPrice.textContent = `Current: $${product.currentPrice ? product.currentPrice.toFixed(2) : 'N/A'}`;
            newPriceInput.value = product.currentPrice || '';

            // Pre-fill store in modal with the current default store
            updatePriceModalStoreInput.value = defaultStoreName;

            updatePriceModal.classList.add('show');
            newPriceInput.focus();
            updateLastActiveTimestamp(); // Update timestamp when showing modal
        }

        submitNewPriceBtn.addEventListener('click', () => {
            const newPrice = parseFloat(newPriceInput.value.trim());
            const newStore = updatePriceModalStoreInput.value.trim() || defaultStoreName;

            if (productToUpdateIndex !== null && !isNaN(newPrice) && newPrice >= 0) {
                const product = products[productToUpdateIndex];
                product.priceHistory.push({
                    price: newPrice,
                    timestamp: new Date().toISOString(),
                    store: newStore
                });
                saveProducts();
                renderProducts();
                console.log(`Price for ${product.name} updated to $${newPrice.toFixed(2)} at ${newStore || 'N/A'}`);
            } else {
                console.warn('Invalid price entered. Please enter a valid number.');
                showErrorMessage('Invalid price entered. Please enter a valid number.');
            }
            updatePriceModal.classList.remove('show');
            productToUpdateIndex = null;
            updatePriceModalStoreInput.value = '';
            updateLastActiveTimestamp(); // Update timestamp after submission
        });

        cancelNewPriceBtn.addEventListener('click', () => {
            updatePriceModal.classList.remove('show');
            productToUpdateIndex = null;
            updatePriceModalStoreInput.value = '';
            updateLastActiveTimestamp(); // Update timestamp on cancel
        });

        closeUpdatePriceModalBtn.addEventListener('click', () => {
            updatePriceModal.classList.remove('show');
            productToUpdateIndex = null;
            updatePriceModalStoreInput.value = '';
            updateLastActiveTimestamp(); // Update timestamp on close button
        });

        updatePriceModal.addEventListener('click', (event) => {
            if (event.target === updatePriceModal) {
                updatePriceModal.classList.remove('show');
                productToUpdateIndex = null;
                updatePriceModalStoreInput.value = '';
                updateLastActiveTimestamp(); // Update timestamp on modal outside click
            }
        });

        newPriceInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                // Add a slight delay to ensure focus change is processed
                setTimeout(() => {
                    submitNewPriceBtn.click();
                }, 0);
            }
        });
        // --- End Update Price Modal Logic ---


        addProductBtn.addEventListener('click', () => {
            const name = productNameInput.value.trim();
            const unit = productUnitInput.value;
            const initialPriceStr = initialPriceInput.value.trim();
            const store = defaultStoreName;

            if (!name) {
                console.warn('Please enter a product name.');
                showErrorMessage('Please enter a product name.');
                return;
            }

            let initialPrice = null;
            if (initialPriceStr) {
                initialPrice = parseFloat(initialPriceStr);
                if (isNaN(initialPrice) || initialPrice < 0) {
                    console.warn('Invalid initial price entered. Please enter a valid number.');
                    showErrorMessage('Invalid initial price entered. Please enter a valid number.');
                    return;
                }
            }

            const existingProduct = products.find(p => p.name.toLowerCase() === name.toLowerCase());

            if (existingProduct) {
                if (initialPrice !== null) {
                    existingProduct.priceHistory.push({
                        price: initialPrice,
                        timestamp: new Date().toISOString(),
                        store: store
                    });
                }
                // Only update the unit if a value is provided (i.e., it's not the default empty option)
                if (unit) {
                    existingProduct.unit = unit;
                }
                console.log(`Updated price history for existing product: ${name}`);
            } else {
                const newProduct = {
                    id: Date.now(),
                    name: name,
                    unit: unit, // Set unit for new products
                    priceHistory: [],
                    currentPrice: null,
                    averagePrice: null,
                    highestPrice: null,
                    lowestPrice: null
                };

                if (initialPrice !== null) {
                    newProduct.priceHistory.push({
                        price: initialPrice,
                        timestamp: new Date().toISOString(),
                        store: store
                    });
                }
                products.push(newProduct);
                console.log(`Added new product: ${name}`);
            }

            saveProducts();
            renderProducts();

            // Clear product name and price fields, and reset unit to empty
            productNameInput.value = '';
            initialPriceInput.value = '';
            productUnitInput.value = ''; // Reset unit to default empty
            
            console.log(`Product Name Input after add/clear: "${productNameInput.value}"`); // Debugging line
            console.log(`Initial Price Input after add/clear: "${initialPriceInput.value}"`); // Debugging line
            console.log(`Product Unit Input after add/clear: "${productUnitInput.value}"`); // Debugging line

            console.log("Products array after adding:", products);
            updateLastActiveTimestamp(); // Update timestamp after adding a product
        });

        function saveProducts() {
            try {
                localStorage.setItem('trackedProducts', JSON.stringify(products));
                localStorage.setItem('modernPriceWindowMonths', modernPriceWindowMonths);
                localStorage.setItem('defaultStoreName', defaultStoreName);
                console.log("Data saved to localStorage.");
            } catch (e) {
                console.error("Error saving to localStorage:", e);
                showErrorMessage('Error saving data. Please check browser storage settings.');
            }
        }

        modernPriceWindowMonthsInput.addEventListener('change', (event) => {
            let newWindow = parseInt(event.target.value);
            if (!isNaN(newWindow) && newWindow >= 1) {
                modernPriceWindowMonths = newWindow;
                saveProducts();
                renderProducts();
            } else {
                console.warn('Please enter a valid number of months (1 or more).');
                showErrorMessage('Please enter a valid number of months (1 or more).');
                event.target.value = modernPriceWindowMonths;
            }
            updateLastActiveTimestamp(); // Update timestamp on settings change
        });

        // Add this new event listener for the modernPriceWindowMonthsInput
        modernPriceWindowMonthsInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent default Enter key behavior (e.g., form submission)
                // Trigger the change logic immediately
                const changeEvent = new Event('change');
                modernPriceWindowMonthsInput.dispatchEvent(changeEvent);
                // Close the settings modal
                settingsModal.classList.remove('show');
            }
        });

        // Logic to show initial store modal on app load if defaultStoreName is not set or if inactive
        document.addEventListener('DOMContentLoaded', () => {
            // Re-load defaultStoreName just to be sure it's fresh for initial check
            defaultStoreName = localStorage.getItem('defaultStoreName') || '';
            defaultStoreNameInput.value = defaultStoreName; // Keep this updated

            const lastActiveTimestamp = parseInt(localStorage.getItem('lastActiveTimestamp') || '0');
            const currentTime = Date.now();
            const isInactive = (currentTime - lastActiveTimestamp) > INACTIVITY_TIMEOUT_MS;

            if (!defaultStoreName || isInactive) {
                initialStoreModal.classList.add('show');
                initialStoreNameInput.focus(); // Focus the input field in the modal
            } else {
                renderProducts(); // If store is already set and not inactive, render products normally
                updateLastActiveTimestamp(); // Immediately update timestamp on active load
            }
        });

        // Event listener for submitting the initial store name
        submitInitialStoreBtn.addEventListener('click', () => {
            const storeName = initialStoreNameInput.value.trim();
            defaultStoreName = storeName; // Can be blank if user just presses Enter
            localStorage.setItem('defaultStoreName', defaultStoreName);
            defaultStoreNameInput.value = defaultStoreName; // Update main UI's store name input
            initialStoreModal.classList.remove('show');
            renderProducts(); // Render products after setting the initial store
            updateLastActiveTimestamp(); // Update timestamp after initial store selection
        });

        // Event listener for the new Skip button
        skipInitialStoreBtn.addEventListener('click', () => {
            defaultStoreName = ''; // Set store name to blank
            localStorage.setItem('defaultStoreName', defaultStoreName);
            defaultStoreNameInput.value = defaultStoreName; // Update main UI's store name input
            initialStoreModal.classList.remove('show');
            renderProducts(); // Render products after skipping
            updateLastActiveTimestamp(); // Update timestamp after skipping initial store
        });

        // Allow pressing Enter in the initial store name input to submit or skip
        initialStoreNameInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                // If the input is blank, treat Enter as a skip action
                if (initialStoreNameInput.value.trim() === '') {
                    skipInitialStoreBtn.click();
                } else {
                    submitInitialStoreBtn.click();
                }
            }
        });


        // Set up custom autocomplete for all relevant inputs
        setupAutocomplete(productNameInput, productSuggestions, getUniqueProductNames);
        setupAutocomplete(defaultStoreNameInput, defaultStoreSuggestions, getUniqueStoreNames);
        setupAutocomplete(updatePriceModalStoreInput, updateStoreSuggestions, getUniqueStoreNames);
        // Also set up autocomplete for the new initial store input
        setupAutocomplete(initialStoreNameInput, initialStoreSuggestions, getUniqueStoreNames);


        // --- KEYBOARD NAVIGATION LOGIC ---
        defaultStoreNameInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                setTimeout(() => {
                    productNameInput.focus(); // Move focus to Product Name
                }, 0);
            }
        });

        productNameInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent default form submission
                setTimeout(() => {
                    initialPriceInput.focus(); // Move focus to Current Price
                }, 0);
            }
        });

        initialPriceInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent default form submission
                setTimeout(() => {
                    productUnitInput.focus(); // Move focus to Unit
                }, 0);
            }
        });

        productUnitInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent default form submission
                setTimeout(() => {
                    addProductBtn.click(); // Simulate click on Add Product button
                }, 0);
            }
        });

        // --- END KEYBOARD NAVIGATION LOGIC ---


        // --- Modal Logic (Settings) ---
        openSettingsBtn.addEventListener('click', () => {
            settingsModal.classList.add('show');
            updateLastActiveTimestamp(); // Update timestamp when opening settings
        });

        closeSettingsBtn.addEventListener('click', () => {
            settingsModal.classList.remove('show');
            renderProducts();
            updateLastActiveTimestamp(); // Update timestamp when closing settings
        });

        // Close modal if user clicks outside of it
        settingsModal.addEventListener('click', (event) => {
            if (event.target === settingsModal) {
                settingsModal.classList.remove('show');
                renderProducts();
                updateLastActiveTimestamp(); // Update timestamp on modal outside click
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                // If initial store modal is active, pressing Escape should trigger skip
                if (initialStoreModal.classList.contains('show')) {
                    skipInitialStoreBtn.click();
                } else {
                    settingsModal.classList.remove('show');
                    confirmModal.classList.remove('show');
                    updatePriceModal.classList.remove('show');
                    // Hide any active autocomplete suggestions
                    defaultStoreSuggestions.style.display = 'none';
                    updateStoreSuggestions.style.display = 'none';
                    productSuggestions.style.display = 'none';
                    initialStoreSuggestions.style.display = 'none';
                    productToDeleteId = null;
                    productToUpdateIndex = null;
                    // Only re-render if a store name is available (or if it was skipped initially)
                    if (defaultStoreName || !initialStoreModal.classList.contains('show')) {
                        renderProducts();
                    }
                    updateLastActiveTimestamp(); // Update timestamp on Escape
                }
            }
        });
    </script>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grocery Price Tracker PWA</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Web App Manifest -->
    <link rel="manifest" href="/manifest.json">
    <!-- Theme color for browser UI -->
    <meta name="theme-color" content="#3B82F6">
    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="/icon-192x192.png">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Light gray background */
            color: #1e293b; /* Dark text */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top for better scrolling */
            min-height: 100vh;
            padding: 2rem;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1.5rem; /* More rounded corners */
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 768px; /* Max width for readability */
            width: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        h1 {
            color: #1a202c; /* Darker heading */
            font-size: 2.8rem; /* Larger heading */
            font-weight: 700;
            text-align: center;
            margin-bottom: 1.5rem;
        }
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .input-group label {
            font-weight: 600;
            color: #475569;
        }
        .input-group input[type="text"],
        .input-group input[type="number"],
        .input-group select { /* Added select to styling */
            padding: 0.8rem 1rem;
            border: 1px solid #cbd5e1; /* Light border */
            border-radius: 0.75rem; /* Rounded input fields */
            font-size: 1rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            width: 100%;
            box-sizing: border-box;
        }
        .input-group input[type="text"]:focus,
        .input-group input[type="number"]:focus,
        .input-group select:focus { /* Added select to focus styling */
            outline: none;
            border-color: #3B82F6; /* Blue focus border */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); /* Blue shadow on focus */
        }
        .btn-primary {
            background-color: #3B82F6; /* Blue button */
            color: white;
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 0.75rem;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.2);
            width: 100%;
        }
        .btn-primary:hover {
            background-color: #2563eb; /* Darker blue on hover */
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
        }
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.2);
        }
        .install-button {
            background-color: #10B981; /* Green install button */
            color: white;
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 0.75rem;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin-top: 1.5rem;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.2);
            width: 100%;
        }
        .install-button:hover {
            background-color: #059669;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }
        .install-button:active {
            transform: translateY(0);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.2);
        }
        .product-list {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .product-item {
            background-color: #f1f5f9; /* Lighter background for items */
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            cursor: pointer; /* Indicate it's clickable */
            transition: transform 0.1s ease, box-shadow 0.1s ease;
        }
        .product-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
        }
        .product-item:active {
            transform: translateY(0);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        .product-item h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1e293b;
        }
        .product-item p {
            font-size: 0.95rem;
            color: #475569;
        }
        .price-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.5rem 1rem;
            margin-top: 0.5rem;
            align-items: center;
        }
        .price-info-grid > div {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .price-info-grid span {
            font-size: 1.2rem;
            font-weight: 700;
            color: #ef4444;
        }
        .price-info-grid .label {
            font-size: 0.8rem;
            color: #64748b;
            font-weight: 500;
        }
        .price-info-grid .value {
            font-size: 1rem;
            font-weight: 600;
            color: #1e293b;
        }
        .price-info-grid .current-price-value {
            color: #ef4444;
            font-size: 1.2rem;
        }
        .price-info-grid .avg-price-value {
            color: #059669;
        }
        .price-info-grid .high-price-value {
            color: #dc2626;
        }
        .price-info-grid .low-price-value {
            color: #2563eb;
        }

        .btn-secondary {
            background-color: #e2e8f0;
            color: #1e293b;
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 0.6rem;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }
        .btn-secondary:hover {
            background-color: #cbd5e1;
            transform: translateY(-1px);
        }
        .btn-secondary:active {
            transform: translateY(0);
        }
        .delete-btn {
            background-color: #ef4444;
            color: white;
        }
        .delete-btn:hover {
            background-color: #dc2626;
        }

        /* Modal specific styles (General) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Ensure it's on top */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25);
            max-width: 500px;
            width: 90%;
            position: relative;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }
        .modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #64748b;
            transition: color 0.2s ease;
        }
        .modal-close-btn:hover {
            color: #1e293b;
        }

        /* Settings Button */
        .settings-button-container {
            width: 100%;
            text-align: right;
            margin-bottom: 1rem;
        }
        .settings-button {
            background-color: #60a5fa; /* A lighter blue */
            color: white;
            padding: 0.6rem 1.2rem;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            box-shadow: 0 3px 10px rgba(96, 165, 250, 0.2);
        }
        .settings-button:hover {
            background-color: #3b82f6;
        }

        /* Confirmation & Update Price Modal specific styles */
        .confirm-modal-content, .update-price-modal-content {
            text-align: center;
        }
        .confirm-modal-content h3, .update-price-modal-content h3 {
            font-size: 1.8rem;
            color: #1e293b;
            margin-bottom: 1rem;
        }
        .confirm-modal-content p, .update-price-modal-content p {
            font-size: 1.1rem;
            color: #475569;
            margin-bottom: 2rem;
        }
        .confirm-buttons, .update-price-buttons {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
        }
        .confirm-buttons .btn, .update-price-buttons .btn { /* General button styling for confirm buttons */
            padding: 0.8rem 1.8rem;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .confirm-buttons .btn-yes, .update-price-buttons .btn-confirm {
            background-color: #ef4444; /* Red for Yes/Confirm */
            color: white;
        }
        .confirm-buttons .btn-yes:hover, .update-price-buttons .btn-confirm:hover {
            background-color: #dc2626;
            transform: translateY(-2px);
        }
        .confirm-buttons .btn-no, .update-price-buttons .btn-cancel {
            background-color: #cbd5e1; /* Gray for No/Cancel */
            color: #1e293b;
        }
        .confirm-buttons .btn-no:hover, .update-price-buttons .btn-cancel:hover {
            background-color: #aebacd;
            transform: translateY(-2px);
        }
        .update-price-modal-content input[type="number"] {
            margin-top: 1rem;
            padding: 0.8rem 1rem;
            border: 1px solid #cbd5e1;
            border-radius: 0.75rem;
            font-size: 1.2rem;
            text-align: center;
            width: calc(100% - 2rem); /* Account for padding */
            max-width: 200px;
            box-sizing: border-box;
        }

        /* Responsive adjustments for modal buttons */
        @media (max-width: 480px) {
            .confirm-buttons, .update-price-buttons {
                flex-direction: column;
                gap: 1rem;
            }
            .confirm-buttons .btn, .update-price-buttons .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="settings-button-container">
            <button id="openSettingsBtn" class="settings-button">Settings</button>
        </div>

        <h1>🛍️ Grocery Price Tracker</h1>

        <div class="add-product-section bg-gray-50 p-6 rounded-xl shadow-inner">
            <h2 class="text-2xl font-semibold text-center mb-4 text-gray-700">Add New Product</h2>
            <div class="input-grid">
                <div class="input-group">
                    <label for="productName">Product Name:</label>
                    <input type="text" id="productName" placeholder="e.g., Milk" class="focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="input-group">
                    <label for="productUnit">Unit (Optional):</label>
                    <select id="productUnit" class="focus:ring-blue-500 focus:border-blue-500">
                        <option value="">-- Select Unit --</option>
                        <option value="ea">Each</option>
                        <option value="lb">lb</option>
                        <option value="oz">oz</option>
                        <option value="g">g</option>
                        <option value="kg">kg</option>
                        <option value="fl oz">fl oz</option>
                        <option value="ml">ml</option>
                        <option value="liter">Liter</option>
                        <option value="gallon">Gallon</option>
                        <option value="pack">Pack</option>
                        <option value="dozen">Dozen</option>
                        <option value="box">Box</option>
                        <option value="bag">Bag</option>
                        <option value="bottle">Bottle</option>
                        <option value="can">Can</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="initialPrice">Current Price:</label>
                    <input type="number" id="initialPrice" step="0.01" min="0" placeholder="e.g., 3.99" class="focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button id="addProductBtn" class="btn-primary">Add Product</button>
            </div>
        </div>

        <div class="tracked-products-section">
            <h2 class="text-2xl font-semibold text-center mb-4 text-gray-700">Tracked Products</h2>
            <div id="productList" class="product-list">
                <!-- Product items will be dynamically added here -->
                <p id="noProductsMessage" class="text-center text-gray-500 italic">No products tracked yet. Add one above!</p>
            </div>
        </div>

        <button id="installButton" class="install-button hidden">Install App</button>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" id="closeSettingsBtn">&times;</button>
            <h2 class="text-2xl font-semibold text-center mb-4 text-gray-700">Settings</h2>
            <div class="input-group">
                <label for="modernPriceWindowMonths">Modern Price Window (Months):</label>
                <input type="number" id="modernPriceWindowMonths" value="12" min="1" class="focus:ring-blue-500 focus:border-blue-500">
                <p class="text-sm text-gray-500 mt-1">High and Low prices will only consider prices from the last X months.</p>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal-overlay">
        <div class="modal-content confirm-modal-content">
            <h3>Confirm Deletion</h3>
            <p id="confirmMessage">Are you sure you want to delete this product?</p>
            <div class="confirm-buttons">
                <button id="confirmDeleteBtn" class="btn btn-yes">Yes, Delete</button>
                <button id="cancelDeleteBtn" class="btn btn-no">No, Cancel</button>
            </div>
        </div>
    </div>

    <!-- Update Price Modal -->
    <div id="updatePriceModal" class="modal-overlay">
        <div class="modal-content update-price-modal-content">
            <button class="modal-close-btn" id="closeUpdatePriceModalBtn">&times;</button>
            <h3 id="updatePriceModalTitle">Update Price for Product</h3>
            <p id="updatePriceModalCurrentPrice"></p>
            <div class="input-group">
                <label for="newPriceInput">New Price:</label>
                <input type="number" id="newPriceInput" step="0.01" min="0" placeholder="e.g., 4.25" class="focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="update-price-buttons mt-6">
                <button id="submitNewPriceBtn" class="btn btn-confirm">Update</button>
                <button id="cancelNewPriceBtn" class="btn btn-cancel">Cancel</button>
            </div>
        </div>
    </div>


    <script>
        // DOM Elements
        const productNameInput = document.getElementById('productName');
        const productUnitInput = document.getElementById('productUnit');
        const initialPriceInput = document.getElementById('initialPrice');
        const addProductBtn = document.getElementById('addProductBtn');
        const productListDiv = document.getElementById('productList');
        const noProductsMessage = document.getElementById('noProductsMessage');
        const installButton = document.getElementById('installButton');
        const modernPriceWindowMonthsInput = document.getElementById('modernPriceWindowMonths');

        // Modal Elements
        const openSettingsBtn = document.getElementById('openSettingsBtn');
        const closeSettingsBtn = document.getElementById('closeSettingsBtn');
        const settingsModal = document.getElementById('settingsModal');

        // Confirmation Modal Elements
        const confirmModal = document.getElementById('confirmModal');
        const confirmMessage = document.getElementById('confirmMessage');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');

        // Update Price Modal Elements
        const updatePriceModal = document.getElementById('updatePriceModal');
        const closeUpdatePriceModalBtn = document.getElementById('closeUpdatePriceModalBtn');
        const updatePriceModalTitle = document.getElementById('updatePriceModalTitle');
        const updatePriceModalCurrentPrice = document.getElementById('updatePriceModalCurrentPrice');
        const newPriceInput = document.getElementById('newPriceInput');
        const submitNewPriceBtn = document.getElementById('submitNewPriceBtn');
        const cancelNewPriceBtn = document.getElementById('cancelNewPriceBtn');

        let deferredPrompt; // For PWA install prompt
        let productToDeleteId = null; // Store ID of product to be deleted
        let productToUpdateIndex = null; // Store index of product being updated

        // --- PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered:', registration);
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }

        // --- PWA Install Prompt Logic ---
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installButton.classList.remove('hidden');
        });

        installButton.addEventListener('click', () => {
            installButton.classList.add('hidden');
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the A2HS prompt');
                    } else {
                        console.log('User dismissed the A2HS prompt');
                    }
                    deferredPrompt = null;
                });
            }
        });

        window.addEventListener('appinstalled', () => {
            console.log('PWA was installed!');
            installButton.classList.add('hidden');
        });

        // --- Product Tracking Logic ---

        let products = JSON.parse(localStorage.getItem('trackedProducts')) || [];
        let modernPriceWindowMonths = parseInt(localStorage.getItem('modernPriceWindowMonths')) || 12;
        modernPriceWindowMonthsInput.value = modernPriceWindowMonths;

        function updateProductStatistics(product) {
            if (product.priceHistory && product.priceHistory.length > 0) {
                const now = new Date();
                const currentMonthTotal = now.getFullYear() * 12 + now.getMonth();

                const modernPrices = product.priceHistory.filter(entry => {
                    const priceDate = new Date(entry.timestamp);
                    const entryMonthTotal = priceDate.getFullYear() * 12 + priceDate.getMonth();
                    const diffMonths = currentMonthTotal - entryMonthTotal;
                    return diffMonths <= modernPriceWindowMonths;
                }).map(entry => entry.price);

                const allPrices = product.priceHistory.map(entry => entry.price);

                product.currentPrice = allPrices[allPrices.length - 1];
                product.averagePrice = allPrices.reduce((sum, p) => sum + p, 0) / allPrices.length;

                if (modernPrices.length > 0) {
                    product.highestPrice = Math.max(...modernPrices);
                    product.lowestPrice = Math.min(...modernPrices);
                } else {
                    product.highestPrice = null;
                    product.lowestPrice = null;
                }
            } else {
                product.currentPrice = null;
                product.averagePrice = null;
                product.highestPrice = null;
                product.lowestPrice = null;
            }
        }

        function renderProducts() {
            productListDiv.innerHTML = '';
            if (products.length === 0) {
                noProductsMessage.classList.remove('hidden');
                productListDiv.appendChild(noProductsMessage);
                return;
            } else {
                noProductsMessage.classList.add('hidden');
            }

            const sortedProducts = [...products].sort((a, b) => a.name.localeCompare(b.name));

            sortedProducts.forEach((product) => {
                updateProductStatistics(product);

                const productItem = document.createElement('div');
                productItem.className = 'product-item';
                productItem.dataset.productName = product.name; // For populating input field
                productItem.dataset.productId = product.id; // For event delegation
                productItem.innerHTML = `
                    <div class="product-details">
                        <h3>${product.name} ${product.unit ? `<span class="text-gray-500 text-sm font-normal">(${product.unit})</span>` : ''}</h3>
                    </div>
                    <div class="price-actions">
                        <div class="price-info-grid">
                            <div>
                                <span class="label">Current Price:</span>
                                <span class="value current-price-value">$${product.currentPrice ? product.currentPrice.toFixed(2) : 'N/A'}</span>
                            </div>
                            <div>
                                <span class="label">Average Price:</span>
                                <span class="value avg-price-value">$${product.averagePrice ? product.averagePrice.toFixed(2) : 'N/A'}</span>
                            </div>
                            <div>
                                <span class="label">Highest Price (Modern):</span>
                                <span class="value high-price-value">$${product.highestPrice ? product.highestPrice.toFixed(2) : 'N/A'}</span>
                            </div>
                            <div>
                                <span class="label">Lowest Price (Modern):</span>
                                <span class="value low-price-value">$${product.lowestPrice ? product.lowestPrice.toFixed(2) : 'N/A'}</span>
                            </div>
                        </div>
                        <small class="text-gray-500 mt-2">Last Updated: ${product.priceHistory.length > 0 ? new Date(product.priceHistory[product.priceHistory.length - 1].timestamp).toLocaleString() : 'Never'}</small>
                        <button class="btn-secondary check-price-btn mt-2" data-product-id="${product.id}">Update Price</button>
                        <button class="btn-secondary delete-product-btn delete-btn" data-product-id="${product.id}">Delete</button>
                    </div>
                `;
                productListDiv.appendChild(productItem);
            });

            // Event delegation for clicks on product items and buttons
            // This listener is added only once outside of renderProducts loop
            productListDiv.onclick = (event) => { // Using .onclick to ensure only one listener, overriding any previous ones
                // Handle product item click to populate name field
                if (event.target.closest('.product-item')) {
                    const item = event.target.closest('.product-item');
                    // Only populate if not clicking directly on a button within the item
                    if (!event.target.closest('.check-price-btn') && !event.target.closest('.delete-product-btn')) {
                        const productName = item.dataset.productName;
                        if (productName) {
                            productNameInput.value = productName;
                        }
                    }
                }

                // Handle Update Price button click
                if (event.target.classList.contains('check-price-btn')) {
                    const productId = parseInt(event.target.dataset.productId);
                    const productIndex = products.findIndex(p => p.id === productId);
                    if (productIndex > -1) {
                        showUpdatePriceModal(productIndex); // Show custom modal
                    }
                }

                // Handle Delete button click (show confirmation modal)
                if (event.target.classList.contains('delete-product-btn')) {
                    const productId = parseInt(event.target.dataset.productId);
                    const product = products.find(p => p.id === productId);
                    if (product) {
                        productToDeleteId = productId; // Store the ID
                        confirmMessage.textContent = `Are you sure you want to delete "${product.name}"?`;
                        confirmModal.classList.add('show'); // Show the confirmation modal
                    }
                }
            };
        }

        // Function to perform the actual deletion after confirmation
        function performDeleteProduct() {
            if (productToDeleteId !== null) {
                const indexToDelete = products.findIndex(p => p.id === productToDeleteId);
                if (indexToDelete > -1) {
                    products.splice(indexToDelete, 1);
                    saveProducts();
                    renderProducts();
                    console.log(`Product with ID ${productToDeleteId} deleted.`);
                }
                productToDeleteId = null; // Reset
            }
            confirmModal.classList.remove('show'); // Hide modal regardless
        }

        // Add event listeners for confirmation modal buttons
        confirmDeleteBtn.addEventListener('click', performDeleteProduct);
        cancelDeleteBtn.addEventListener('click', () => {
            confirmModal.classList.remove('show');
            productToDeleteId = null; // Clear ID if canceled
        });

        // Close confirm modal if user clicks outside of it
        confirmModal.addEventListener('click', (event) => {
            if (event.target === confirmModal) {
                confirmModal.classList.remove('show');
                productToDeleteId = null; // Clear ID if canceled
            }
        });


        // --- New: Update Price Modal Logic ---
        function showUpdatePriceModal(productIndex) {
            productToUpdateIndex = productIndex; // Store the index of the product being updated
            const product = products[productIndex];

            updatePriceModalTitle.textContent = `Update Price for "${product.name}"`;
            updatePriceModalCurrentPrice.textContent = `Current: $${product.currentPrice ? product.currentPrice.toFixed(2) : 'N/A'}`;
            newPriceInput.value = product.currentPrice || ''; // Pre-fill with current price or empty
            updatePriceModal.classList.add('show');
            newPriceInput.focus(); // Focus on the input field
        }

        submitNewPriceBtn.addEventListener('click', () => {
            const newPrice = parseFloat(newPriceInput.value.trim());
            if (productToUpdateIndex !== null && !isNaN(newPrice) && newPrice >= 0) {
                const product = products[productToUpdateIndex];
                product.priceHistory.push({
                    price: newPrice,
                    timestamp: new Date().toISOString()
                });
                saveProducts();
                renderProducts();
                console.log(`Price for ${product.name} updated to $${newPrice.toFixed(2)}`);
            } else {
                console.warn('Invalid price entered. Please enter a valid number.');
            }
            updatePriceModal.classList.remove('show');
            productToUpdateIndex = null; // Reset
        });

        cancelNewPriceBtn.addEventListener('click', () => {
            updatePriceModal.classList.remove('show');
            productToUpdateIndex = null; // Reset
        });

        closeUpdatePriceModalBtn.addEventListener('click', () => {
            updatePriceModal.classList.remove('show');
            productToUpdateIndex = null; // Reset
        });

        updatePriceModal.addEventListener('click', (event) => {
            if (event.target === updatePriceModal) {
                updatePriceModal.classList.remove('show');
                productToUpdateIndex = null; // Reset
            }
        });

        newPriceInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                submitNewPriceBtn.click(); // Simulate click on update button
            }
        });
        // --- End New: Update Price Modal Logic ---


        addProductBtn.addEventListener('click', () => {
            const name = productNameInput.value.trim();
            const unit = productUnitInput.value;
            const initialPriceStr = initialPriceInput.value.trim();

            if (!name) {
                console.warn('Please enter a product name.');
                return;
            }

            let initialPrice = null;
            if (initialPriceStr) {
                initialPrice = parseFloat(initialPriceStr);
                if (isNaN(initialPrice) || initialPrice < 0) {
                    console.warn('Invalid initial price entered. Please enter a valid number.');
                    return;
                }
            }

            const existingProduct = products.find(p => p.name.toLowerCase() === name.toLowerCase());

            if (existingProduct) {
                if (initialPrice !== null) {
                    existingProduct.priceHistory.push({
                        price: initialPrice,
                        timestamp: new Date().toISOString()
                    });
                }
                if (unit) {
                    existingProduct.unit = unit;
                }
                console.log(`Updated price history for existing product: ${name}`);
            } else {
                const newProduct = {
                    id: Date.now(),
                    name: name,
                    unit: unit,
                    priceHistory: [],
                    currentPrice: null,
                    averagePrice: null,
                    highestPrice: null,
                    lowestPrice: null
                };

                if (initialPrice !== null) {
                    newProduct.priceHistory.push({
                        price: initialPrice,
                        timestamp: new Date().toISOString()
                    });
                }
                products.push(newProduct);
                console.log(`Added new product: ${name}`);
            }

            saveProducts();
            renderProducts();
            productNameInput.value = '';
            productUnitInput.value = '';
            initialPriceInput.value = '';
        });

        function saveProducts() {
            localStorage.setItem('trackedProducts', JSON.stringify(products));
            localStorage.setItem('modernPriceWindowMonths', modernPriceWindowMonths);
        }

        modernPriceWindowMonthsInput.addEventListener('change', (event) => {
            let newWindow = parseInt(event.target.value);
            if (!isNaN(newWindow) && newWindow >= 1) {
                modernPriceWindowMonths = newWindow;
                saveProducts();
                renderProducts();
            } else {
                console.warn('Please enter a valid number of months (1 or more).');
                event.target.value = modernPriceWindowMonths;
            }
        });

        // Initial render on load
        renderProducts();

        initialPriceInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                addProductBtn.click();
            }
        });

        // --- Modal Logic (Settings) ---
        openSettingsBtn.addEventListener('click', () => {
            settingsModal.classList.add('show');
        });

        closeSettingsBtn.addEventListener('click', () => {
            settingsModal.classList.remove('show');
            renderProducts(); // Re-render products to update statistics if settings changed while modal was open
        });

        // Close modal if user clicks outside of it
        settingsModal.addEventListener('click', (event) => {
            if (event.target === settingsModal) {
                settingsModal.classList.remove('show');
                renderProducts(); // Re-render products
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                settingsModal.classList.remove('show');
                confirmModal.classList.remove('show');
                updatePriceModal.classList.remove('show'); // Also close update price modal
                productToDeleteId = null; // Clear ID if confirm modal closed by escape
                productToUpdateIndex = null; // Clear index if update modal closed by escape
                renderProducts(); // Re-render products
            }
        });
    </script>
